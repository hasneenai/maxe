<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAVEN - موقع المحاضرات التعليمي العراقي</title>
    <meta name="description" content="موقع CAVEN التعليمي العراقي - محاضرات مجانية ومنظمة لجميع المواد الدراسية">
    <meta name="keywords" content="محاضرات, تعليم, عراق, مجاني, دراسة, جامعة">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <!-- إضافة في head -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

    <!-- إضافة قبل إغلاق body -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<style>
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Reset and Base Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  height: 100%;
  overflow-x: hidden;
  font-size: 16px;
}

body {
  font-family: 'Cairo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.6;
  color: #333;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  direction: rtl;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  position: relative;
  contain: layout style;
}

.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
  overflow: hidden;
  contain: layout;
}

/* Header Styles */
.header {
  background: rgba(255, 255, 255, 0.1);
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  padding: 0.75rem 0;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 2px 10px rgba(31, 38, 135, 0.25);
  backdrop-filter: blur(10px);
}

.header .container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.75rem;
  min-height: 3rem;
}

.logo h1 {
  color: #fff;
  font-size: clamp(1.25rem, 4vw, 2.5rem);
  font-weight: 900;
  margin-bottom: 0.1rem;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  line-height: 1.1;
}

.logo p {
  color: rgba(255, 255, 255, 0.9);
  font-size: clamp(0.7rem, 2vw, 0.9rem);
  font-weight: 300;
}

.nav {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.nav-link {
  color: #fff;
  text-decoration: none;
  padding: 0.5rem 1rem;
  border-radius: 25px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  font-weight: 500;
  font-size: clamp(0.75rem, 2vw, 0.9rem);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  white-space: nowrap;
}

.nav-link:hover {
  background: linear-gradient(45deg, #ff6b6b, #feca57);
  transform: translateY(-1px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* Main Content */
.main {
  flex: 1;
  padding: 1rem 0;
  min-height: calc(100vh - 120px);
  overflow: hidden;
  contain: layout style;
  position: relative;
}

.page {
  display: none;
  animation: fadeIn 0.5s ease-in-out;
  overflow: hidden;
  contain: layout style;
}

.page.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Hero Section */
.hero-section {
  text-align: center;
  margin-bottom: 2rem;
  padding: 1.5rem 0;
}

.hero-title {
  font-size: clamp(1.75rem, 6vw, 3rem);
  color: #fff;
  margin-bottom: 0.75rem;
  font-weight: 700;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  line-height: 1.2;
}

.hero-subtitle {
  font-size: clamp(0.9rem, 3vw, 1.2rem);
  color: rgba(255, 255, 255, 0.9);
  font-weight: 300;
  line-height: 1.4;
}

/* Year Selection */
.year-selection {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr));
  gap: 1rem;
  max-width: 800px;
  margin: 0 auto;
}

.year-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
  border-radius: 12px;
  padding: 1.5rem 1rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  position: relative;
  overflow: hidden;
  min-height: 180px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.year-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, #ff9a9e, #fecfef, #fecfef, #ff9a9e);
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: -1;
}

.year-card:hover::before {
  opacity: 0.1;
}

.year-card:hover {
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.year-icon {
  font-size: clamp(2.5rem, 8vw, 4rem);
  color: #feca57;
  margin-bottom: 0.75rem;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
}

.year-card h3 {
  color: #fff;
  font-size: clamp(1.2rem, 4vw, 1.8rem);
  margin-bottom: 0.5rem;
  font-weight: 600;
  line-height: 1.2;
}

.year-card p {
  color: rgba(255, 255, 255, 0.8);
  font-size: clamp(0.85rem, 2.5vw, 1rem);
  margin-bottom: 0.75rem;
  line-height: 1.4;
}

.year-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: linear-gradient(45deg, #ff6b6b, #feca57);
  color: #fff;
  padding: 0.25rem 0.6rem;
  border-radius: 12px;
  font-size: clamp(0.7rem, 2vw, 0.8rem);
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* Page Header */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.page-header h2 {
  color: #fff;
  font-size: clamp(1.25rem, 4vw, 2rem);
  font-weight: 600;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
  line-height: 1.2;
}

.btn-back {
  background: linear-gradient(45deg, #ff6b6b, #feca57);
  color: #fff;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 20px;
  cursor: pointer;
  font-size: clamp(0.8rem, 2.5vw, 1rem);
  font-weight: 500;
  transition: all 0.3s ease;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
  white-space: nowrap;
}

.btn-back:hover {
  transform: translateY(-1px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

/* Grid Layouts */
.subjects-grid,
.teachers-grid,
.classes-grid,
.lectures-grid {
  display: grid;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.subjects-grid {
  grid-template-columns: repeat(auto-fit, minmax(min(220px, 100%), 1fr));
}

.teachers-grid {
  grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
}

.classes-grid {
  grid-template-columns: repeat(auto-fit, minmax(min(230px, 100%), 1fr));
}

.lectures-grid {
  grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr));
}

/* Card Styles */
.subject-card,
.teacher-card,
.class-card,
.lecture-card {
  background: rgba(255, 255, 255, 0.12);
  border-radius: 10px;
  padding: 1.25rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.2);
  position: relative;
  overflow: hidden;
  box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
}

.subject-card::before,
.teacher-card::before,
.class-card::before,
.lecture-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, #a8edea, #fed6e3);
  opacity: 0;
  transition: opacity 0.2s ease;
  z-index: -1;
}

.subject-card:hover::before,
.teacher-card:hover::before,
.class-card:hover::before,
.lecture-card:hover::before {
  opacity: 0.08;
}

.subject-card:hover,
.teacher-card:hover,
.class-card:hover,
.lecture-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

/* Teacher Card Specific */
.teacher-card {
  text-align: center;
  min-height: 280px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.teacher-avatar {
  width: clamp(50px, 12vw, 70px);
  height: clamp(50px, 12vw, 70px);
  border-radius: 50%;
  margin: 0 auto 1rem;
  object-fit: cover;
  border: 2px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.teacher-name {
  color: #fff;
  font-size: clamp(1rem, 3vw, 1.2rem);
  font-weight: 600;
  margin-bottom: 0.5rem;
  line-height: 1.3;
}

.teacher-subject {
  color: rgba(255, 255, 255, 0.8);
  font-size: clamp(0.85rem, 2.5vw, 1rem);
  margin-bottom: 1rem;
  line-height: 1.4;
}

.teacher-stats {
  display: flex;
  justify-content: space-around;
  margin-bottom: 1rem;
  gap: 0.5rem;
}

.stat {
  text-align: center;
  flex: 1;
}

.stat-number {
  color: #feca57;
  font-size: clamp(1.1rem, 3.5vw, 1.5rem);
  font-weight: 700;
  display: block;
  line-height: 1.1;
}

.stat-label {
  color: rgba(255, 255, 255, 0.7);
  font-size: clamp(0.7rem, 2vw, 0.8rem);
  line-height: 1.2;
}

.teacher-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
}

.btn-star,
.btn-heart {
  background: none;
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.7);
  padding: 0.4rem;
  border-radius: 50%;
  width: clamp(32px, 8vw, 40px);
  height: clamp(32px, 8vw, 40px);
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(0.8rem, 2vw, 1rem);
}

.btn-star:hover,
.btn-heart:hover {
  background: linear-gradient(45deg, #ff9a9e, #fecfef);
  color: #fff;
  transform: scale(1.05);
}

.btn-star.active {
  background: linear-gradient(45deg, #feca57, #ff9a9e);
  color: #fff;
  border-color: #feca57;
}

/* Lecture Card Specific */
.lecture-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
  gap: 0.75rem;
}

.lecture-title {
  color: #fff;
  font-size: clamp(1rem, 3vw, 1.2rem);
  font-weight: 600;
  flex: 1;
  line-height: 1.3;
}

.lecture-description {
  color: rgba(255, 255, 255, 0.8);
  font-size: clamp(0.8rem, 2.5vw, 0.9rem);
  margin-bottom: 1rem;
  line-height: 1.5;
}

.lecture-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.5rem;
}

.lecture-duration {
  color: #feca57;
  font-size: clamp(0.8rem, 2.5vw, 0.9rem);
  font-weight: 500;
}

.btn-check {
  background: none;
  border: 2px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.7);
  padding: 0.25rem;
  border-radius: 50%;
  width: clamp(28px, 7vw, 35px);
  height: clamp(28px, 7vw, 35px);
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(0.7rem, 2vw, 0.9rem);
}

.btn-check:hover {
  border-color: #48ca8b;
  color: #48ca8b;
  transform: scale(1.05);
}

.btn-check.completed {
  background: linear-gradient(45deg, #48ca8b, #56ab2f);
  border-color: #48ca8b;
  color: #fff;
}

.lecture-card.completed {
  background: rgba(72, 202, 139, 0.2);
  border-color: rgba(72, 202, 139, 0.4);
}

/* Video Player */
.player-container {
  max-width: min(1200px, 95vw);
  margin: 0 auto;
}

.video-wrapper {
  position: relative;
  width: 100%;
  height: 0;
  padding-bottom: min(56.25%, 70vh); /* Responsive aspect ratio */
  margin-bottom: 1.5rem;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
  background: #000;
}

.video-wrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
}

.video-wrapper video {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
  background: #000;
  object-fit: contain;
}

/* Video Player - Simple and Fast */
.player-container {
  max-width: min(1200px, 95vw);
  margin: 0 auto;
  overflow: hidden; /* Prevent content from extending beyond boundaries */
  contain: layout style;
  position: relative;
  z-index: 1;
}

.video-wrapper {
  position: relative;
  width: 100%;
  height: 0;
  padding-bottom: min(56.25%, 70vh);
  margin-bottom: 1.5rem;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
  background: #000;
  contain: layout style; /* Improve rendering performance */
}

.video-wrapper video {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
  background: #000;
  object-fit: contain;
}

/* Hide all native video controls completely to prevent double controls */
video::-webkit-media-controls {
  display: none !important;
}

video::-webkit-media-controls-panel {
  display: none !important;
}

video::-webkit-media-controls-play-button {
  display: none !important;
}

video::-webkit-media-controls-start-playback-button {
  display: none !important;
}

video::-webkit-media-controls-timeline {
  display: none !important;
}

video::-webkit-media-controls-current-time-display {
  display: none !important;
}

video::-webkit-media-controls-time-remaining-display {
  display: none !important;
}

video::-webkit-media-controls-mute-button {
  display: none !important;
}

video::-webkit-media-controls-volume-slider {
  display: none !important;
}

video::-webkit-media-controls-fullscreen-button {
  display: none !important;
}

video::-webkit-media-controls-toggle-closed-captions-button {
  display: none !important;
}

/* Firefox */
video::-moz-media-controls {
  display: none !important;
}

/* Microsoft Edge/IE */
video::-ms-media-controls {
  display: none !important;
}

/* Force video to never show controls */
video {
  -webkit-appearance: none;
  appearance: none;
}

video[controls] {
  -webkit-appearance: none;
  appearance: none;
}

/* Enhanced fullscreen controls auto-hide - YouTube style */
.video-wrapper:fullscreen .custom-controls,
.video-wrapper:-webkit-full-screen .custom-controls,
.video-wrapper:-moz-full-screen .custom-controls {
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
}

.video-wrapper:fullscreen .custom-controls.show,
.video-wrapper:-webkit-full-screen .custom-controls.show,
.video-wrapper:-moz-full-screen .custom-controls.show {
  opacity: 1;
  pointer-events: all;
}

/* iOS Safari fullscreen specific */
video:-webkit-full-screen ~ .custom-controls {
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
}

video:-webkit-full-screen ~ .custom-controls.show {
  opacity: 1;
  pointer-events: all;
}

/* Force hide controls in fullscreen after timeout */
.video-wrapper:fullscreen .custom-controls:not(.show),
.video-wrapper:-webkit-full-screen .custom-controls:not(.show),
.video-wrapper:-moz-full-screen .custom-controls:not(.show) {
  opacity: 0 !important;
  visibility: hidden;
  pointer-events: none;
}

/* Ensure smooth transitions in fullscreen */
.video-wrapper:fullscreen,
.video-wrapper:-webkit-full-screen,
.video-wrapper:-moz-full-screen {
  background: #000;
}

.video-wrapper:fullscreen .custom-controls,
.video-wrapper:-webkit-full-screen .custom-controls,
.video-wrapper:-moz-full-screen .custom-controls {
  background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.4) 60%, transparent 100%);
}

/* Video watermark removed - no longer needed */

/* Bunny.net Style Video Player Controls - Enhanced Auto-Hide */
.custom-controls {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(to top, rgba(0, 0, 0, 0.75) 0%, rgba(0, 0, 0, 0.5) 60%, transparent 100%);
  padding: 0;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  z-index: 100;
  pointer-events: none;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* Show controls only when .show class is present */
.custom-controls.show {
  opacity: 1;
  visibility: visible;
  pointer-events: all;
}

/* Force hide controls when not showing */
.custom-controls:not(.show) {
  opacity: 0 !important;
  visibility: hidden !important;
  pointer-events: none !important;
}

/* Bunny.net Progress Bar Style */
.progress-container {
  padding: 12px 16px 0;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.progress-bar {
  width: 100%;
  height: 3px;
  background: rgba(255, 255, 255, 0.25);
  border-radius: 1.5px;
  position: relative;
  overflow: visible;
  cursor: pointer;
}

.progress-buffered {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  background: rgba(255, 255, 255, 0.4);
  border-radius: 1.5px;
  width: 0%;
  transition: width 0.2s ease;
}

.progress-played {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  background: #ff6b35;
  border-radius: 1.5px;
  width: 0%;
  transition: width 0.1s ease;
}

.progress-handle {
  position: absolute;
  top: 50%;
  transform: translateY(-50%) translateX(-50%);
  width: 12px;
  height: 12px;
  background: #ff6b35;
  border-radius: 50%;
  box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.3);
  left: 0%;
  opacity: 0;
  transition: all 0.2s ease;
  cursor: pointer;
}

.progress-container:hover .progress-handle,
.progress-container.dragging .progress-handle {
  opacity: 1;
}

.progress-bar:hover {
  height: 5px;
  margin-top: -1px;
}

.progress-bar:hover .progress-handle {
  width: 14px;
  height: 14px;
}

/* Bunny.net Controls Bar Style */
.controls-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 16px 14px;
  gap: 12px;
}

.controls-left,
.controls-right {
  display: flex;
  align-items: center;
  gap: 6px;
}

.control-btn {
  background: none;
  border: none;
  color: #fff;
  padding: 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 36px;
  height: 36px;
  font-size: 16px;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
  -webkit-user-select: none;
  touch-action: manipulation;
  position: relative;
  z-index: 10;
}

.control-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: scale(1.05);
}

.control-btn:active {
  transform: scale(0.95);
  background: rgba(255, 255, 255, 0.25);
}

.control-btn:focus {
  outline: none;
  background: rgba(255, 255, 255, 0.2);
}

.control-btn i {
  pointer-events: none;
  filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.3));
}

/* Bunny.net Play Button Style */
#play-pause-btn {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  min-width: 40px;
}

#play-pause-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

/* Bunny.net Volume Control Style */
.volume-control {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Desktop-only controls */
.desktop-only {
  display: flex;
}

/* Hide volume controls on mobile - use device volume instead */
@media (max-width: 768px) {
  .desktop-only {
    display: none !important;
  }
}

.volume-slider {
  width: 70px;
  opacity: 0;
  transform: scaleX(0);
  transition: all 0.3s ease;
  transform-origin: left;
}

.volume-control:hover .volume-slider {
  opacity: 1;
  transform: scaleX(1);
}

.volume-bar {
  width: 100%;
  height: 3px;
  background: rgba(255, 255, 255, 0.25);
  border-radius: 1.5px;
  position: relative;
  cursor: pointer;
}

.volume-fill {
  height: 100%;
  background: #fff;
  border-radius: 1.5px;
  width: 100%;
  transition: width 0.1s ease;
}

.volume-handle {
  position: absolute;
  top: 50%;
  right: 0;
  transform: translateY(-50%) translateX(50%);
  width: 10px;
  height: 10px;
  background: #fff;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.2s ease;
  opacity: 0;
}

.volume-bar:hover .volume-handle {
  opacity: 1;
  transform: translateY(-50%) translateX(50%) scale(1.2);
}

/* Bunny.net Time Display Style */
.time-display {
  color: #fff;
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
  margin-left: 8px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  font-feature-settings: "tnum";
  font-variant-numeric: tabular-nums;
}

/* Bunny.net Speed Control Style */
.speed-control {
  position: relative;
}

.speed-btn {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  padding: 6px 8px;
  font-size: 12px;
  gap: 4px;
  min-width: auto;
  height: 28px;
  font-weight: 600;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.speed-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.2);
}

.speed-btn span {
  font-weight: 600;
  min-width: 18px;
  text-align: center;
  font-size: 11px;
}

.speed-menu {
  position: absolute;
  bottom: 100%;
  right: 0;
  background: rgba(24, 24, 24, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 6px;
  padding: 8px 0;
  margin-bottom: 8px;
  opacity: 0;
  visibility: hidden;
  transform: translateY(10px);
  transition: all 0.2s ease;
  min-width: 60px;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.speed-control:hover .speed-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.speed-option {
  padding: 8px 12px;
  color: #fff;
  cursor: pointer;
  transition: background 0.2s ease;
  font-size: 12px;
  text-align: center;
  font-weight: 600;
}

.speed-option:hover {
  background: rgba(255, 255, 255, 0.1);
}

.speed-option.active {
  background: #ff6b35;
  color: #fff;
}

/* Video Loading */
.video-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 50;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.video-loading.show {
  opacity: 1;
  visibility: visible;
}

.video-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top: 3px solid #ff4757;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

/* Zoom Effect - Enhanced with pinch support */
.video-wrapper.zoomed video {
  transform: scale(1.6);
  transition: transform 0.3s ease;
  transform-origin: center;
}

.video-wrapper.zoom-1-1 video { transform: scale(1.1); }
.video-wrapper.zoom-1-2 video { transform: scale(1.2); }
.video-wrapper.zoom-1-3 video { transform: scale(1.3); }
.video-wrapper.zoom-1-4 video { transform: scale(1.4); }
.video-wrapper.zoom-1-5 video { transform: scale(1.5); }
.video-wrapper.zoom-1-6 video { transform: scale(1.6); }

/* Video Toast Messages */
.video-toast {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  z-index: 200;
  pointer-events: none;
  backdrop-filter: blur(4px);
}

.video-toast.show {
  opacity: 1;
  visibility: visible;
}

/* Mobile Skip Indicators */
.skip-indicator {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 80px;
  height: 80px;
  background: rgba(0, 0, 0, 0.7);
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  z-index: 150;
  pointer-events: none;
}

.skip-indicator.left {
  left: 20px;
}

.skip-indicator.right {
  right: 20px;
}

.skip-indicator.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(-50%) scale(1.1);
}

.skip-indicator i {
  font-size: 24px;
  margin-bottom: 4px;
}

.skip-indicator span {
  font-size: 12px;
  font-weight: 600;
}

/* Picture-in-Picture and AirPlay buttons */
#pip-btn, #airplay-btn {
  background: rgba(255, 255, 255, 0.1);
}

#pip-btn:hover, #airplay-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

#airplay-btn.available {
  background: rgba(0, 122, 255, 0.8);
}

/* Enhanced Speed Control */
.speed-btn span {
  min-width: 24px;
  text-align: center;
}

.speed-menu {
  min-width: 60px;
}

/* Enhanced Mobile Responsive - Smaller, More Appropriate Controls */
@media (max-width: 768px) {
  .custom-controls {
    padding: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.6) 70%, transparent 100%);
  }

  .progress-container {
    padding: 8px 12px 0;
  }

  .progress-bar {
    height: 6px;
    cursor: pointer;
  }

  .progress-handle {
    width: 16px;
    height: 16px;
    opacity: 1;
  }

  .controls-bar {
    padding: 6px 12px 10px;
    gap: 6px;
    flex-wrap: nowrap;
  }

  .controls-left,
  .controls-right {
    gap: 4px;
  }

  .control-btn {
    min-width: 32px;
    height: 32px;
    font-size: 14px;
    padding: 6px;
    touch-action: manipulation;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
  }

  #play-pause-btn {
    min-width: 34px;
    height: 34px;
    font-size: 15px;
  }

  #fullscreen-btn {
    min-width: 32px;
    height: 32px;
    font-size: 14px;
  }

  .time-display {
    font-size: 11px;
    font-weight: 600;
    margin-left: 4px;
  }

  .speed-btn {
    padding: 4px 6px;
    font-size: 10px;
    min-height: 32px;
    width: 36px;
  }

  /* Hide volume controls on mobile */
  .desktop-only {
    display: none !important;
  }
}

@media (max-width: 480px) {
  .custom-controls {
    padding: 0;
  }

  .progress-container {
    padding: 6px 10px 0;
  }

  .controls-bar {
    padding: 5px 10px 8px;
    gap: 4px;
    justify-content: space-between;
  }

  .controls-left {
    gap: 3px;
  }

  .controls-right {
    gap: 3px;
  }

  .controls-left .time-display {
    font-size: 10px;
    margin-left: 3px;
  }

  .volume-control {
    position: relative;
  }

  .volume-slider {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) scaleX(0);
    margin-bottom: 8px;
    width: 70px;
    background: rgba(0, 0, 0, 0.9);
    padding: 8px;
    border-radius: 6px;
    opacity: 0;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
  }

  .volume-control:hover .volume-slider,
  .volume-control.show .volume-slider {
    opacity: 1;
    transform: translateX(-50%) scaleX(1);
  }

  .controls-right {
    flex-wrap: nowrap;
    justify-content: flex-end;
  }

  .control-btn {
    min-width: 28px;
    height: 28px;
    font-size: 12px;
  }

  #play-pause-btn {
    min-width: 30px;
    height: 30px;
    font-size: 13px;
  }

  #fullscreen-btn {
    min-width: 28px;
    height: 28px;
    font-size: 12px;
  }

  .progress-bar {
    height: 8px;
  }

  .progress-handle {
    width: 18px;
    height: 18px;
  }

  .speed-btn {
    width: 32px;
    font-size: 9px;
    padding: 3px 4px;
  }

  /* Ensure zoom button is visible */
  #zoom-btn {
    min-width: 28px;
    background: rgba(255, 255, 255, 0.15);
  }
}

/* iOS Safari Specific Fixes */
@supports (-webkit-touch-callout: none) {
  .video-wrapper {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }

  .custom-controls {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
  }

  .control-btn {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
  }

  .progress-container,
  .volume-slider {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  /* Force inline playback */
  video {
    -webkit-playsinline: true;
    -webkit-presentation-mode: inline;
  }
}

/* Enhanced Touch device optimizations - Smaller controls for better UX */
@media (hover: none) and (pointer: coarse) {
  .custom-controls {
    opacity: 1;
    pointer-events: all;
  }

  .video-wrapper:hover .custom-controls,
  .custom-controls.show {
    opacity: 1;
    pointer-events: all;
  }

  .control-btn {
    min-width: 36px;
    height: 36px;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    font-size: 14px;
  }

  #play-pause-btn {
    min-width: 38px;
    height: 38px;
    font-size: 15px;
  }

  #fullscreen-btn {
    min-width: 36px;
    height: 36px;
    font-size: 14px;
  }

  .progress-container {
    padding: 12px 15px 0;
    touch-action: manipulation;
  }

  .progress-bar {
    height: 8px;
  }

  .progress-handle {
    width: 18px;
    height: 18px;
    opacity: 1;
  }

  .volume-bar {
    height: 6px;
  }

  .volume-handle {
    width: 14px;
    height: 14px;
  }

  /* Always show volume slider on touch devices */
  .volume-control .volume-slider {
    opacity: 0;
    transform: scaleX(0);
    width: 90px;
  }

  .volume-control:hover .volume-slider,
  .volume-control.active .volume-slider {
    opacity: 1;
    transform: scaleX(1);
  }

  /* Make zoom button more prominent on touch devices */
  #zoom-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  #zoom-btn:active, #zoom-btn.active {
    background: rgba(255, 107, 53, 0.9);
    transform: scale(0.95);
  }
}

/* Prevent zoom on double-tap for controls only */
.custom-controls * {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}

/* Video wrapper touch handling */
.video-wrapper {
  touch-action: manipulation;
  -webkit-user-select: none;
  user-select: none;
}

/* Ensure video stays responsive */
.video-wrapper video {
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
  will-change: transform;
}

/* Large tablets and desktop - Properly sized controls */
@media (min-width: 769px) and (max-width: 1024px) {
  .control-btn {
    min-width: 38px;
    height: 38px;
    font-size: 15px;
  }

  #play-pause-btn {
    min-width: 42px;
    height: 42px;
    font-size: 17px;
  }

  .volume-slider {
    width: 90px;
  }

  .time-display {
    font-size: 14px;
  }

  .speed-btn {
    width: 40px;
    font-size: 11px;
  }
}

/* Ultra-wide screens - Desktop controls */
@media (min-width: 1400px) {
  .control-btn {
    min-width: 40px;
    height: 40px;
    font-size: 17px;
  }

  #play-pause-btn {
    min-width: 44px;
    height: 44px;
    font-size: 19px;
  }

  .volume-slider {
    width: 100px;
  }

  .time-display {
    font-size: 15px;
  }

  .speed-btn {
    width: 42px;
    font-size: 12px;
  }
}
@media (max-width: 768px) {
  .video-wrapper {
    padding-bottom: min(56.25%, 50vh);
    border-radius: 12px;
  }

  #video-watermark {
    top: 12px;
    left: 12px;
    font-size: 11px;
    padding: 4px 8px;
  }
}

@media (max-width: 480px) {
  .video-wrapper {
    padding-bottom: min(56.25%, 45vh);
    border-radius: 8px;
  }

  .lecture-details {
    padding: 1rem;
    margin: 0 0.5rem;
  }

  .lecture-actions {
    flex-direction: column;
    gap: 0.5rem;
  }

  .btn-complete,
  .btn-favorite {
    min-width: 100%;
    padding: 0.7rem 1rem;
  }

  .navigation-controls {
    flex-direction: column;
    gap: 0.5rem;
  }

  .btn-nav {
    min-width: 100%;
    padding: 0.7rem 1rem;
  }
}

.lecture-details {
  background: rgba(255, 255, 255, 0.12);
  border-radius: 12px;
  padding: min(1.5rem, 4vw);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.2);
  max-width: 100%;
  overflow: hidden;
  position: relative;
  z-index: 1;
  contain: layout style;
  box-sizing: border-box;
}

.lecture-details h2 {
  color: #fff;
  font-size: clamp(1.25rem, 4vw, 2rem);
  margin-bottom: 1.25rem;
  text-align: center;
  line-height: 1.2;
}

.teacher-details {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
}

#teacher-avatar {
  width: clamp(45px, 10vw, 60px);
  height: clamp(45px, 10vw, 60px);
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid rgba(255, 255, 255, 0.3);
  flex-shrink: 0;
  background: linear-gradient(45deg, #667eea, #764ba2);
  display: block;
}

.teacher-details h3 {
  color: #fff;
  font-size: clamp(1rem, 3vw, 1.3rem);
  margin-bottom: 0.2rem;
  line-height: 1.2;
}

.teacher-details p {
  color: rgba(255, 255, 255, 0.8);
  font-size: clamp(0.85rem, 2.5vw, 1rem);
  line-height: 1.3;
}

.lecture-description {
  margin-bottom: 1.5rem;
}

.lecture-description h4 {
  color: #feca57;
  font-size: clamp(1rem, 3vw, 1.2rem);
  margin-bottom: 0.75rem;
  line-height: 1.2;
}

.lecture-description p {
  color: rgba(255, 255, 255, 0.9);
  line-height: 1.6;
  font-size: clamp(0.85rem, 2.5vw, 1rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
}

.lecture-actions {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.btn-complete,
.btn-favorite {
  flex: 1;
  min-width: 150px;
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 20px;
  font-size: clamp(0.85rem, 2.5vw, 1rem);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
  white-space: nowrap;
}

.btn-complete {
  background: linear-gradient(45deg, #48ca8b, #56ab2f);
  color: #fff;
}

.btn-complete.completed {
  background: linear-gradient(45deg, #ff6b6b, #feca57);
}

.btn-favorite {
  background: linear-gradient(45deg, #feca57, #ff9a9e);
  color: #fff;
}

.btn-favorite.active {
  background: linear-gradient(45deg, #ff6b6b, #ff9a9e);
}

.btn-complete:hover,
.btn-favorite:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

.navigation-controls {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.btn-nav {
  flex: 1;
  min-width: 140px;
  padding: 0.8rem 1.5rem;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #fff;
  border-radius: 20px;
  font-size: clamp(0.85rem, 2.5vw, 1rem);
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
  white-space: nowrap;
}

.btn-nav:hover {
  background: linear-gradient(45deg, #667eea, #764ba2);
  transform: translateY(-1px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.btn-nav:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* Breadcrumb */
.breadcrumb {
  margin-bottom: 1.5rem;
  padding: 0.75rem;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.breadcrumb-item {
  color: rgba(255, 255, 255, 0.8);
  text-decoration: none;
  cursor: pointer;
  transition: color 0.3s ease;
  font-size: clamp(0.8rem, 2.5vw, 0.9rem);
}

.breadcrumb-item:hover {
  color: #feca57;
}

.breadcrumb-item::after {
  content: ' > ';
  margin: 0 0.4rem;
  color: rgba(255, 255, 255, 0.5);
}

.breadcrumb-item:last-child::after {
  display: none;
}

/* Footer - Fixed for mobile and boundaries */
.footer {
  background: rgba(255, 255, 255, 0.05);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  padding: 1.5rem 0 1rem;
  margin-top: auto;
  backdrop-filter: blur(10px);
  position: relative;
  z-index: 0;
  contain: layout style;
  overflow: hidden;
  width: 100%;
  box-sizing: border-box;
}

.footer-content {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-bottom: 1.5rem;
  text-align: center;
  max-width: 100%;
  overflow: hidden;
  contain: layout;
}

.footer-section h3,
.footer-section h4 {
  color: #fff;
  margin-bottom: 0.75rem;
  font-weight: 600;
  font-size: clamp(0.9rem, 3vw, 1.1rem);
}

.footer-section p,
.footer-section li {
  color: rgba(255, 255, 255, 0.8);
  line-height: 1.5;
  font-size: clamp(0.8rem, 2.5vw, 0.9rem);
}

.footer-section ul {
  list-style: none;
}

.footer-section ul li {
  margin-bottom: 0.4rem;
}

.footer-section a {
  color: rgba(255, 255, 255, 0.8);
  text-decoration: none;
  transition: color 0.3s ease;
}

.footer-section a:hover {
  color: #feca57;
}

.social-links {
  display: flex;
  gap: 0.75rem;
  justify-content: center;
  flex-wrap: wrap;
}

.social-links a {
  width: clamp(32px, 8vw, 40px);
  height: clamp(32px, 8vw, 40px);
  background: rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(0.9rem, 2.5vw, 1.2rem);
  transition: all 0.3s ease;
}

.social-links a:hover {
  background: linear-gradient(45deg, #ff6b6b, #feca57);
  transform: translateY(-1px);
}

.footer-bottom {
  text-align: center;
  padding-top: 1rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.footer-bottom p {
  color: rgba(255, 255, 255, 0.6);
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  margin: 0;
}

/* Loading Spinner */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.spinner {
  width: clamp(40px, 10vw, 50px);
  height: clamp(40px, 10vw, 50px);
  border: 3px solid rgba(255, 255, 255, 0.1);
  border-top: 3px solid #feca57;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Toast Notifications */
.toast {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  left: 1rem;
  background: linear-gradient(45deg, #48ca8b, #56ab2f);
  color: #fff;
  padding: 1rem;
  border-radius: 20px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
  transform: translateY(100px);
  transition: transform 0.3s ease;
  z-index: 1000;
  font-weight: 500;
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  text-align: center;
}

.toast.show {
  transform: translateY(0);
}

.toast.error {
  background: linear-gradient(45deg, #ff6b6b, #feca57);
}

/* Responsive Breakpoints */

/* Small Mobile (320px - 480px) */
@media (max-width: 480px) {
  html {
    font-size: 14px;
  }

  .container {
    padding: 0 0.75rem;
  }

  .header {
    padding: 0.5rem 0;
  }

  .header .container {
    flex-direction: column;
    gap: 0.5rem;
    text-align: center;
  }

  .nav {
    width: 100%;
    justify-content: center;
  }

  .nav-link {
    flex: 1;
    text-align: center;
    min-width: 0;
  }

  .main {
    padding: 0.75rem 0;
  }

  .hero-section {
    padding: 1rem 0;
    margin-bottom: 1.5rem;
  }

  .year-selection {
    gap: 0.75rem;
  }

  .year-card {
    padding: 1rem 0.75rem;
    min-height: 150px;
  }

  .page-header {
    flex-direction: column;
    text-align: center;
    gap: 0.75rem;
  }

  .subjects-grid,
  .teachers-grid,
  .classes-grid {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }

  .lectures-grid {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }

  .subject-card,
  .teacher-card,
  .class-card,
  .lecture-card {
    padding: 1rem;
  }

  .teacher-card {
    min-height: 240px;
  }

  .teacher-stats {
    gap: 0.25rem;
  }

  .lecture-actions {
    flex-direction: column;
    gap: 0.5rem;
  }

  .btn-complete,
  .btn-favorite {
    min-width: auto;
  }

  .navigation-controls {
    flex-direction: column;
    gap: 0.5rem;
  }

  .btn-nav {
    min-width: auto;
  }

  .lecture-details {
    padding: 1rem;
  }

  .teacher-details {
    padding: 0.75rem;
    flex-direction: column;
    text-align: center;
    gap: 0.75rem;
  }

  /* Footer mobile fixes */
  .footer {
    padding: 1rem 0 0.5rem;
    margin-top: 1rem;
  }

  .footer-content {
    grid-template-columns: 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .footer-section {
    padding: 0.5rem 0;
  }

  .social-links {
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .footer-bottom {
    padding-top: 0.75rem;
  }
}

/* Medium Mobile (481px - 768px) */
@media (min-width: 481px) and (max-width: 768px) {
  .subjects-grid,
  .teachers-grid,
  .classes-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .lectures-grid {
    grid-template-columns: 1fr;
  }

  .lecture-actions {
    gap: 0.5rem;
  }

  .navigation-controls {
    gap: 0.5rem;
  }

  /* Footer tablet fixes */
  .footer-content {
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
  }
}

/* Tablet (769px - 1024px) */
@media (min-width: 769px) and (max-width: 1024px) {
  .year-selection {
    grid-template-columns: repeat(2, 1fr);
  }

  .subjects-grid {
    grid-template-columns: repeat(3, 1fr);
  }

  .teachers-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .classes-grid {
    grid-template-columns: repeat(3, 1fr);
  }

  .lectures-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .footer-content {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* Large Desktop (1025px+) */
@media (min-width: 1025px) {
  .container {
    padding: 0 2rem;
  }

  .teachers-grid {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }

  .subjects-grid {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }

  .classes-grid {
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  }

  .lectures-grid {
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  }

  .toast {
    right: 2rem;
    left: auto;
    max-width: 400px;
    transform: translateX(400px);
  }

  .toast.show {
    transform: translateX(0);
  }

  .footer-content {
    grid-template-columns: repeat(4, 1fr);
    text-align: left;
  }
}

/* Print Styles */
@media print {
  .header,
  .footer,
  .btn-back,
  .lecture-actions,
  .navigation-controls {
    display: none;
  }

  body {
    background: white;
    color: black;
  }

  .page {
    display: block !important;
  }
}

/* High DPI Displays */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .teacher-avatar,
  #teacher-avatar {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }
}

/* Landscape Mobile */
@media (max-height: 500px) and (orientation: landscape) {
  .hero-section {
    padding: 0.5rem 0;
    margin-bottom: 1rem;
  }

  .main {
    padding: 0.5rem 0;
  }

  .year-card {
    min-height: 120px;
  }

  .teacher-card {
    min-height: 200px;
  }

  .footer {
    padding: 0.75rem 0 0.5rem;
  }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Focus Styles */
.nav-link:focus,
.btn-back:focus,
.btn-complete:focus,
.btn-favorite:focus,
.btn-nav:focus,
.btn-star:focus,
.btn-heart:focus,
.btn-check:focus {
  outline: 2px solid #feca57;
  outline-offset: 2px;
}

/* Empty class styling */
.class-card[style*="not-allowed"] {
  background: rgba(255, 255, 255, 0.08);
  border: 1px dashed rgba(255, 255, 255, 0.3);
}

.class-card[style*="not-allowed"] h3 {
  color: rgba(255, 255, 255, 0.7);
}

.class-card[style*="not-allowed"] .stat-number {
  color: rgba(254, 202, 87, 0.7);
}

/* Auth specific styles */
.auth-input-field {
  @apply w-full px-4 py-3 rounded-lg bg-white border border-gray-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all shadow-sm hover:shadow;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
}

.auth-button {
  @apply w-full px-4 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors shadow-sm hover:shadow disabled:opacity-50 disabled:cursor-not-allowed;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
}

/* Utility classes */
.text-primary {
  color: #3b82f6;
}

.text-secondary {
  color: #6b7280;
}

.bg-primary {
  background-color: #3b82f6;
}

.border-primary {
  border-color: #3b82f6;
}

.rounded-container {
  border-radius: 0.5rem;
}

.gap-section {
  gap: 2rem;
}

@media (max-width: 768px) {
  .gap-section {
    gap: 1.5rem;
  }
}

/* iPhone-Specific Enhancements */
@supports (-webkit-touch-callout: none) {
  /* iPhone detection and specific styles */
  .iphone-optimized {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    -webkit-perspective: 1000;
    perspective: 1000;
  }

  .iphone-optimized video {
    -webkit-playsinline: true !important;
    -webkit-presentation-mode: inline !important;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
  }

  /* Enhanced iPhone fullscreen button */
  .iphone-optimized #fullscreen-btn {
    background: rgba(255, 107, 53, 0.2) !important;
    border: 2px solid rgba(255, 107, 53, 0.5) !important;
    color: #ff6b35 !important;
    font-weight: bold;
  }

  .iphone-optimized #fullscreen-btn:hover,
  .iphone-optimized #fullscreen-btn:active {
    background: rgba(255, 107, 53, 0.8) !important;
    color: white !important;
    transform: scale(1.1);
  }

  /* Enhanced iPhone play/pause controls */
  .iphone-optimized #play-pause-btn {
    background: rgba(72, 202, 139, 0.2) !important;
    border: 2px solid rgba(72, 202, 139, 0.5) !important;
    width: 50px !important;
    height: 50px !important;
    min-width: 50px !important;
  }

  .iphone-optimized #play-pause-btn:hover,
  .iphone-optimized #play-pause-btn:active {
    background: rgba(72, 202, 139, 0.8) !important;
    transform: scale(1.15) !important;
  }

  /* Enhanced iPhone touch targets */
  .iphone-optimized .control-btn {
    min-width: 48px !important;
    height: 48px !important;
    font-size: 18px !important;
    touch-action: manipulation;
    -webkit-tap-highlight-color: rgba(255, 107, 53, 0.3);
  }

  /* iPhone-specific progress bar */
  .iphone-optimized .progress-bar {
    height: 12px !important;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  .iphone-optimized .progress-handle {
    width: 24px !important;
    height: 24px !important;
    opacity: 1 !important;
    background: #ff6b35 !important;
  }

  /* iPhone toast notifications */
  .iphone-optimized + * .toast {
    background: linear-gradient(45deg, #ff6b35, #feca57) !important;
    font-weight: 600;
    font-size: 16px;
  }
}

/* iPhone Media Query for Enhanced Support */
@media screen and (max-device-width: 480px) and (-webkit-min-device-pixel-ratio: 2) {
  /* iPhone-specific video controls */
  .video-wrapper {
    -webkit-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
  }

  video {
    -webkit-playsinline: true !important;
    -webkit-presentation-mode: inline !important;
  }

  .custom-controls {
    background: linear-gradient(to top, rgba(0, 0, 0, 0.95) 0%, rgba(0, 0, 0, 0.7) 70%, transparent 100%) !important;
  }

  .control-btn {
    background: rgba(255, 255, 255, 0.15) !important;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  #fullscreen-btn {
    background: linear-gradient(45deg, #ff6b35, #feca57) !important;
    color: white !important;
    font-weight: bold;
    min-width: 50px !important;
    height: 50px !important;
  }

  #play-pause-btn {
    background: linear-gradient(45deg, #48ca8b, #56ab2f) !important;
    color: white !important;
    min-width: 50px !important;
    height: 50px !important;
  }
}
</style>

</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1><i class="fas fa-graduation-cap"></i> CAVEN</h1>
                <p>موقع المحاضرات التعليمي العراقي</p>
            </div>
            <nav class="nav">
                <a href="#" onclick="showFavorites()" class="nav-link">
                    <i class="fas fa-star"></i> المفضلة
                </a>
                <a href="#" onclick="showHome()" class="nav-link">
                    <i class="fas fa-home"></i> الرئيسية
                </a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Breadcrumb Navigation -->
            <nav class="breadcrumb" id="breadcrumb" style="display: none;">                <span class="breadcrumb-item" onclick="showHome()">الرئيسية</span>
            </nav>

            <!-- Home Page -->
            <div id="home-page" class="page active">
                <div class="hero-section">
                    <h2 class="hero-title">مرحباً بك في موقع CAVEN</h2>
                    <p class="hero-subtitle">اختر السنة الدراسية للوصول إلى المحاضرات</p>
                </div>

                <div class="year-selection">
                    <div class="year-card" onclick="selectYear('2025')">
                        <div class="year-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <h3>محاضرات 2025</h3>
                        <p>الوصول إلى محاضرات سنة 2025</p>
                        <div class="year-badge">قديم</div>
                    </div>

                    <div class="year-card" onclick="selectYear('2026')">
                        <div class="year-icon">
                            <i class="fas fa-calendar-plus"></i>
                        </div>
                        <h3>محاضرات 2026</h3>
                        <p>الوصول إلى محاضرات سنة 2026</p>
                        <div class="year-badge">جديد</div>
                    </div>
                </div>
            </div>

            <!-- Subjects Page -->
            <div id="subjects-page" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-book"></i> المواد الدراسية</h2>
                    <button class="btn-back" onclick="showHome()">
                        <i class="fas fa-arrow-right"></i> العودة للرئيسية
                    </button>
                </div>
                <div id="subjects-container" class="subjects-grid"></div>
            </div>

            <!-- Teachers Page -->
            <div id="teachers-page" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-users"></i> المدرسين</h2>
                    <button class="btn-back" onclick="goBack()">
                        <i class="fas fa-arrow-right"></i> رجوع
                    </button>
                </div>
                <div id="teachers-container" class="teachers-grid"></div>
            </div>

            <!-- Classes Page -->
            <div id="classes-page" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-folder-open"></i> الفصول</h2>
                    <button class="btn-back" onclick="goBack()">
                        <i class="fas fa-arrow-right"></i> رجوع
                    </button>
                </div>
                <div id="classes-container" class="classes-grid"></div>
            </div>

            <!-- Lectures Page -->
            <div id="lectures-page" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-play-circle"></i> المحاضرات</h2>
                    <button class="btn-back" onclick="goBack()">
                        <i class="fas fa-arrow-right"></i> رجوع
                    </button>
                </div>
                <div class="teacher-info" id="teacher-info"></div>
                <div id="lectures-container" class="lectures-grid"></div>
            </div>

            <!-- Favorites Page -->
            <div id="favorites-page" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-star"></i> المدرسين المفضلين</h2>
                    <button class="btn-back" onclick="showHome()">
                        <i class="fas fa-arrow-right"></i> العودة للرئيسية
                    </button>
                </div>
                <div id="favorites-container" class="teachers-grid"></div>
            </div>

            <!-- Lecture Player Page -->
            <div id="player-page" class="page">
                <div class="page-header">
                    <button class="btn-back" onclick="goBack()">
                        <i class="fas fa-arrow-right"></i> رجوع
                    </button>
                </div>

                <div class="player-container">
                    <div class="video-wrapper">
                        <!-- [مهم] الفيديو مهيأ لـ iOS inline + AirPlay + Autoplay + iPhone Support -->
                        <video id="video-player"
                            preload="metadata"
                            playsinline webkit-playsinline x-webkit-airplay="allow"
                            controls="false"
                            controlslist="nodownload noremoteplayback nofullscreen"
                            disablepictureinpicture="false"
                            autoplay
                            muted
                            webkit-playsinline="true"
                            style="width: 100%; height: 100%; border: none; background: #000;"
                            oncontextmenu="return false;">
                            <source src="" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>

                        <!-- Custom Video Controls -->
                        <div class="custom-controls" id="custom-controls">
                            <!-- Progress Bar Container -->
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-buffered" id="progress-buffered"></div>
                                    <div class="progress-played" id="progress-played"></div>
                                    <div class="progress-handle" id="progress-handle"></div>
                                </div>
                            </div>

                            <!-- Controls Bottom Bar - Simplified Mobile Design -->
                            <div class="controls-bar">
                                <!-- Left Controls -->
                                <div class="controls-left">
                                    <button class="control-btn" id="play-pause-btn">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="control-btn" id="step-backward-btn" title="Backward 10s">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="control-btn" id="step-forward-btn" title="Forward 10s">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    <div class="volume-control desktop-only">
                                        <button class="control-btn" id="volume-btn">
                                            <i class="fas fa-volume-up"></i>
                                        </button>
                                        <div class="volume-slider" id="volume-slider">
                                            <div class="volume-bar">
                                                <div class="volume-fill" id="volume-fill"></div>
                                                <div class="volume-handle" id="volume-handle"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="time-display">
                                        <span id="current-time">0:00</span>                                        <span> / </span>
                                        <span id="duration-time">0:00</span>
                                    </div>
                                </div>

                                <!-- Right Controls -->
                                <div class="controls-right">
                                    <div class="speed-control">
                                        <button class="control-btn speed-btn" id="speed-btn" title="Playback Speed">
                                            <span>1x</span>
                                        </button>
                                        <div class="speed-menu" id="speed-menu">
                                            <div class="speed-option" data-speed="0.5">0.5x</div>
                                            <div class="speed-option active" data-speed="1">1x</div>
                                            <div class="speed-option" data-speed="1.25">1.25x</div>
                                            <div class="speed-option" data-speed="1.5">1.5x</div>
                                            <div class="speed-option" data-speed="2">2x</div>
                                        </div>
                                    </div>
                                    <button class="control-btn" id="fullscreen-btn" title="Fullscreen">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Loading Spinner -->
                        <div class="video-loading" id="video-loading">
                            <div class="video-spinner"></div>
                        </div>

                        <!-- Toast Messages -->
                        <div class="video-toast" id="video-toast"></div>

                        <!-- Mobile Skip Indicators -->
                        <div class="skip-indicator left" id="skip-left">
                            <i class="fas fa-fast-backward"></i>
                            <span>-10s</span>
                        </div>
                        <div class="skip-indicator right" id="skip-right">
                            <i class="fas fa-fast-forward"></i>
                            <span>+10s</span>
                        </div>
                    </div>

                    <div class="lecture-details">
                        <h2 id="lecture-title"></h2>
                        <div class="teacher-details">
                            <img id="teacher-avatar" src="https://via.placeholder.com/60x60/667eea/white?text=مدرس" alt="مدرس" onerror="this.src='https://via.placeholder.com/60x60/667eea/white?text=مدرس';this.onerror=null;">
                            <div>
                                <h3 id="teacher-name"></h3>
                                <p id="teacher-subject"></p>
                            </div>
                        </div>

                        <div class="lecture-description">
                            <h4>وصف المحاضرة:</h4>
                            <p>📱 تابعنا على إنستغرام: @l1pll_<br>
                            📺 قناة المطور للمحاضرات المسربة: @allawi10_l<br>
                            ⭐ لا تنسى وضع المدرس في المفضلة<br>
                            ✅ ضع صح علامة عند إكمال المحاضرة</p>
                        </div>

                        <div class="lecture-actions">
                            <button class="btn-complete" id="btn-complete" onclick="toggleLectureCompletion()">
                                <i class="fas fa-check"></i> تم الانتهاء
                            </button>
                            <button class="btn-favorite" id="btn-favorite" onclick="toggleTeacherFavorite()">
                                <i class="fas fa-star"></i> إضافة للمفضلة
                            </button>
                        </div>

                        <div class="navigation-controls">
                            <button class="btn-nav" id="btn-prev" onclick="playPreviousLecture()">
                                <i class="fas fa-step-backward"></i> المحاضرة السابقة
                            </button>
                            <button class="btn-nav" id="btn-next" onclick="playNextLecture()">
                                المحاضرة التالية <i class="fas fa-step-forward"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3><i class="fas fa-graduation-cap"></i> CAVEN</h3>
                    <p>موقع تعليمي عراقي مجاني يهدف لتوفير المحاضرات المنظمة لجميع الطلاب</p>
                </div>
                <div class="footer-section">
                    <h4>روابط سريعة</h4>
                    <ul>
                        <li><a href="#" onclick="showHome()">الرئيسية</a></li>
                        <li><a href="#" onclick="showFavorites()">المفضلة</a></li>
                        <li><a href="#" onclick="selectYear('2025')">محاضرات 2025</a></li>
                        <li><a href="#" onclick="selectYear('2026')">محاضرات 2026</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>تابعنا</h4>
                    <div class="social-links">
                        <a href="https://www.instagram.com/l1pll_" target="_blank" rel="noopener noreferrer"><i class="fab fa-instagram"></i></a>
                        <a href="https://t.me/allawi10_l" target="_blank" rel="noopener noreferrer"><i class="fab fa-telegram"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 CAVEN - جميع الحقوق محفوظة</p>
            </div>
        </div>
    </footer>

    <!-- Loading Spinner -->
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="teacherData2025.js"></script>
    <script src="teacherData2026.js"></script>
    <script>
    
    
    
    
    // Performance optimizations
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Throttle function for better performance
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}

// Global Variables
let currentYear = '';
let currentData = null;
let currentSubject = '';
let currentTeacher = null;
let currentClass = '';
let currentLectureIndex = 0;
let currentLectures = [];
let navigationHistory = [];

// localStorage keys
const STORAGE_KEYS = {
    FAVORITES: 'caven_favorites',
    COMPLETED: 'caven_completed',
    SELECTED_YEAR: 'caven_selected_year'
};

// Initialize the app with performance optimization
document.addEventListener('DOMContentLoaded', function() {
    // Wait for all scripts to load before initializing
    requestAnimationFrame(() => {
        setTimeout(() => {
            initializeApp();
            // Preload HLS.js for better performance
            if (typeof Hls !== 'undefined') {
                console.log('HLS.js loaded successfully');
            }
        }, 50);
    });

    // Add viewport meta tag if not present for better mobile performance
    if (!document.querySelector('meta[name="viewport"]')) {
        const viewport = document.createElement('meta');
        viewport.name = 'viewport';
        viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes';
        document.head.appendChild(viewport);
    }
});

function initializeApp() {
    // Add a delay to ensure all data files are loaded
    setTimeout(() => {
        // Check if data is loaded
        if (typeof teacherData2025 === 'undefined' || typeof teacherData2026 === 'undefined') {
            console.error('Teacher data not loaded. Please check if data files are properly included.');
            showToast('جاري تحميل البيانات، يرجى الانتظار...', 'info');
            // Retry after another delay
            setTimeout(() => {
                if (typeof teacherData2025 === 'undefined' || typeof teacherData2026 === 'undefined') {
                    showToast('خطأ في تحميل البيانات. يرجى إعادة تحميل الصفحة.', 'error');
                } else {
                    initializeAppData();
                }
            }, 2000);
            return;
        }

        initializeAppData();
    }, 500);
}

function initializeAppData() {
    // Load saved year if exists and is valid
    const savedYear = getFromStorage(STORAGE_KEYS.SELECTED_YEAR);
    if (savedYear && (savedYear === '2025' || savedYear === '2026')) {
        selectYear(savedYear);
    } else {
        // Clear invalid saved year
        localStorage.removeItem(STORAGE_KEYS.SELECTED_YEAR);
        showHome();
    }
}

// Storage Functions
function saveToStorage(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
    } catch (error) {
        console.error('Error saving to localStorage:', error);
        showToast('خطأ في حفظ البيانات', 'error');
    }
}

function getFromStorage(key) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
    } catch (error) {
        console.error('Error loading from localStorage:', error);
        return [];
    }
}

// Navigation Functions - Fixed showHome
function showHome() {
    // تنظيف الفيديو أولاً قبل إخفاء الصفحات
    cleanupVideoPlayer();

    hideAllPages();
    document.getElementById('home-page').classList.add('active');
    document.getElementById('breadcrumb').style.display = 'none';
    navigationHistory = [];
    currentYear = '';
    currentData = null;

    console.log('Returned to home and cleaned up video');
}

function hideAllPages() {
    // تنظيف شامل للفيديو عند الخروج من صفحة المشغل
    const currentPlayerPage = document.getElementById('player-page');
    if (currentPlayerPage && currentPlayerPage.classList.contains('active')) {
        console.log('Leaving player page - cleaning up video');
        cleanupVideoPlayer();
    }

    // إخفاء جميع الصفحات
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));

    // إخفاء عناصر التحميل
    const loadingElements = document.querySelectorAll('.loading-indicator, .spinner');
    loadingElements.forEach(el => {
        if (el) el.style.display = 'none';
    });
}

function goBack() {
    // Clean up video if leaving player page
    const currentPlayerPage = document.getElementById('player-page');
    if (currentPlayerPage && currentPlayerPage.classList.contains('active')) {
        const video = document.getElementById('video-player');
        if (video) {
            video.pause();
            video.currentTime = 0;
        }
        cleanupVideoPlayer();
    }

    if (navigationHistory.length > 0) {
        const previousState = navigationHistory.pop();
        switch (previousState.type) {
            case 'subjects':
                showSubjects(previousState.data);
                break;
            case 'teachers':
                showTeachers(previousState.subject, previousState.data);
                break;
            case 'classes':
                showClasses(previousState.teacher, previousState.data);
                break;
            case 'lectures':
                showLectures(previousState.teacher, previousState.className, previousState.data);
                break;
            default:
                showHome();
        }
    } else {
        showHome();
    }
}

function updateBreadcrumb(items) {
    const breadcrumb = document.getElementById('breadcrumb');
    breadcrumb.innerHTML = '';

    items.forEach((item, index) => {
        const span = document.createElement('span');
        span.className = 'breadcrumb-item';
        span.textContent = item.text;

        if (item.onclick) {
            span.onclick = () => {
                // تنظيف الفيديو قبل التنقل
                const currentPlayerPage = document.getElementById('player-page');
                if (currentPlayerPage && currentPlayerPage.classList.contains('active')) {
                    cleanupVideoPlayer();
                }

                // استدعاء الدالة الأصلية
                item.onclick();
            };
        }

        breadcrumb.appendChild(span);
    });

    breadcrumb.style.display = 'block';
}

// Year Selection
function selectYear(year) {
    showLoading();
    currentYear = year;

    setTimeout(() => {
        try {
            if (year === '2025') {
                if (typeof teacherData2025 === 'undefined') {
                    throw new Error('teacherData2025 is not defined');
                }
                currentData = teacherData2025;
            } else if (year === '2026') {
                if (typeof teacherData2026 === 'undefined') {
                    throw new Error('teacherData2026 is not defined');
                }
                currentData = teacherData2026;
            }

            if (!currentData || !currentData.teachers) {
                throw new Error('Invalid data structure');
            }

            saveToStorage(STORAGE_KEYS.SELECTED_YEAR, year);
            showSubjects(currentData);
        } catch (error) {
            console.error('Error selecting year:', error);
            showToast('خطأ في تحميل بيانات السنة المختارة', 'error');
            showHome();
        } finally {
            hideLoading();
        }
    }, 500);
}

// Show Subjects with performance optimization
function showSubjects(data) {
    hideAllPages();
    document.getElementById('subjects-page').classList.add('active');

    if (!data || !data.teachers || !Array.isArray(data.teachers)) {
        console.error('Invalid data structure in showSubjects:', data);
        showToast('خطأ في هيكل البيانات', 'error');
        showHome();
        return;
    }

    const subjects = getUniqueSubjects(data.teachers);
    const container = document.getElementById('subjects-container');

    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    container.innerHTML = '';

    subjects.forEach(subject => {
        const teacherCount = data.teachers.filter(t => t.subject === subject).length;
        const lectureCount = getTotalLecturesForSubject(data.teachers, subject);

        const card = document.createElement('div');
        card.className = 'subject-card';
        card.onclick = () => {
            navigationHistory.push({ type: 'subjects', data: data });
            showTeachers(subject, data);
        };

        card.innerHTML = `
            <div class="subject-icon">
                <i class="${getSubjectIcon(subject)}"></i>
            </div>
            <h3>${subject}</h3>
            <div class="subject-stats">
                <div class="stat">
                    <span class="stat-number">${teacherCount}</span>
                    <span class="stat-label">مدرس</span>
                </div>
                <div class="stat">
                    <span class="stat-number">${lectureCount}</span>
                    <span class="stat-label">محاضرة</span>
                </div>
            </div>
        `;

        fragment.appendChild(card);
    });

    // Append all at once for better performance
    container.appendChild(fragment);

    updateBreadcrumb([
        { text: 'الرئيسية', onclick: () => showHome() },
        { text: `محاضرات ${currentYear}` }
    ]);
}

function getUniqueSubjects(teachers) {
    const subjects = teachers.map(teacher => {
        // Remove "مدرس مادة" prefix to show only the subject name
        return teacher.subject.replace(/^مدرس مادة\s+/, '');
    });
    return [...new Set(subjects)];
}

function getTotalLecturesForSubject(teachers, subject) {
    return teachers
        .filter(teacher => {
            // Match both full subject name and cleaned subject name
            const cleanedSubject = teacher.subject.replace(/^مدرس مادة\s+/, '');
            return teacher.subject === subject || cleanedSubject === subject;
        })
        .reduce((total, teacher) => {
            return total + teacher.classes.reduce((classTotal, cls) => {
                return classTotal + cls.lectures.length;
            }, 0);
        }, 0);
}

function getSubjectIcon(subject) {
    // Clean subject name and match icons
    const cleanSubject = subject.replace(/^مدرس مادة\s+/, '');

    const icons = {
        'التربية الاسلامية': 'fas fa-mosque',
        'الاحياء': 'fas fa-microscope',
        'الفيزياء': 'fas fa-atom',
        'الكيمياء': 'fas fa-flask',
        'الرياضيات': 'fas fa-calculator',
        'اللغة العربية': 'fas fa-book-open',
        'اللغة الانجليزية': 'fas fa-globe'
    };

    return icons[cleanSubject] || icons[subject] || 'fas fa-book';
}

// Show Teachers with performance optimization
function showTeachers(subject, data) {
    hideAllPages();
    document.getElementById('teachers-page').classList.add('active');
    currentSubject = subject;

    const teachers = data.teachers.filter(teacher => {
        // Match both full subject name and cleaned subject name
        const cleanedSubject = teacher.subject.replace(/^مدرس مادة\s+/, '');
        return teacher.subject === subject || cleanedSubject === subject;
    });
    const container = document.getElementById('teachers-container');

    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    container.innerHTML = '';

    const favorites = getFromStorage(STORAGE_KEYS.FAVORITES);
    const completed = getFromStorage(STORAGE_KEYS.COMPLETED);

    teachers.forEach(teacher => {
        const totalLectures = teacher.classes.reduce((total, cls) => total + cls.lectures.length, 0);
        const completedLectures = getCompletedLecturesForTeacher(teacher, completed);
        const isFavorite = favorites.includes(teacher.id);

        const card = document.createElement('div');
        card.className = 'teacher-card';
        card.onclick = (e) => {
            if (!e.target.closest('.teacher-actions')) {
                navigationHistory.push({ type: 'teachers', subject: subject, data: data });
                showClasses(teacher, data);
            }
        };

        card.innerHTML = `
            <img src="${teacher.image}" alt="${teacher.name}" class="teacher-avatar" onerror="this.src='https://via.placeholder.com/60x60/667eea/white?text=مدرس'">
            <h3 class="teacher-name">${teacher.name}</h3>
            <p class="teacher-subject">${teacher.subject}</p>
            <div class="teacher-stats">
                <div class="stat">
                    <span class="stat-number">${totalLectures}</span>
                    <span class="stat-label">محاضرة</span>
                </div>
                <div class="stat">
                    <span class="stat-number">${completedLectures}</span>
                    <span class="stat-label">مكتملة</span>
                </div>
            </div>
            <div class="teacher-actions">
                <button class="btn-star ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(${teacher.id})">
                    <i class="fas fa-star"></i>
                </button>
            </div>
        `;

        fragment.appendChild(card);
    });

    // Append all at once for better performance
    container.appendChild(fragment);

    updateBreadcrumb([
        { text: 'الرئيسية', onclick: () => showHome() },
        { text: `محاضرات ${currentYear}`, onclick: () => showSubjects(data) },
        { text: subject.replace(/^مدرس مادة\s+/, '') }
    ]);
}

function getCompletedLecturesForTeacher(teacher, completedLectures) {
    let count = 0;
    teacher.classes.forEach(cls => {
        cls.lectures.forEach(lecture => {
            const lectureId = generateLectureId(teacher.id, cls.name, lecture.title);
            if (completedLectures.includes(lectureId)) {
                count++;
            }
        });
    });
    return count;
}

// Show Classes
function showClasses(teacher, data) {
    hideAllPages();
    document.getElementById('classes-page').classList.add('active');
    currentTeacher = teacher;

    const container = document.getElementById('classes-container');
    container.innerHTML = '';

    const completed = getFromStorage(STORAGE_KEYS.COMPLETED);

    teacher.classes.forEach(cls => {
        const completedLectures = cls.lectures.filter(lecture => {
            const lectureId = generateLectureId(teacher.id, cls.name, lecture.title);
            return completed.includes(lectureId);
        }).length;

        // Handle empty classes
        const totalLectures = cls.lectures.length;
        let progressText = '';
        let progressPercentage = '';

        if (totalLectures === 0) {
            progressText = 'قريباً';
            progressPercentage = 'لا تتوفر محاضرات';
        } else {
            progressText = `${completedLectures}/${totalLectures}`;
            progressPercentage = `${Math.round((completedLectures / totalLectures) * 100)}%`;
        }

        const card = document.createElement('div');
        card.className = 'class-card';

        // Only make clickable if there are lectures
        if (totalLectures > 0) {
            card.onclick = () => {
                navigationHistory.push({ type: 'classes', teacher: teacher, data: data });
                showLectures(teacher, cls.name, data);
            };
        } else {
            card.style.opacity = '0.7';
            card.style.cursor = 'not-allowed';
        }

        card.innerHTML = `
            <div class="class-header">
                <h3>${cls.name}</h3>
                <div class="class-progress">
                    <span>${progressText}</span>
                </div>
            </div>
            <div class="class-stats">
                <div class="stat">
                    <span class="stat-number">${totalLectures}</span>
                    <span class="stat-label">محاضرة</span>
                </div>
                <div class="stat">
                    <span class="stat-number">${totalLectures > 0 ? completedLectures : 'قريباً'}</span>
                    <span class="stat-label">${totalLectures > 0 ? 'مكتملة' : ''}</span>
                </div>
                <div class="stat">
                    <span class="stat-number">${progressPercentage}</span>
                    <span class="stat-label">${totalLectures > 0 ? 'التقدم' : ''}</span>
                </div>
            </div>
        `;

        container.appendChild(card);
    });

    updateBreadcrumb([
        { text: 'الرئيسية', onclick: () => showHome() },
        { text: `محاضرات ${currentYear}`, onclick: () => showSubjects(data) },
        { text: currentSubject.replace(/^مدرس مادة\s+/, ''), onclick: () => showTeachers(currentSubject, data) },
        { text: teacher.name }
    ]);
}

// Show Lectures
function showLectures(teacher, className, data) {
    hideAllPages();
    document.getElementById('lectures-page').classList.add('active');
    currentClass = className;

    const classData = teacher.classes.find(cls => cls.name === className);
    const container = document.getElementById('lectures-container');
    container.innerHTML = '';

    // Show teacher info
    const teacherInfo = document.getElementById('teacher-info');
    teacherInfo.innerHTML = `
        <div class="teacher-details">
            <img src="${teacher.image}" alt="${teacher.name}" id="teacher-avatar" onerror="this.src='https://via.placeholder.com/60x60/667eea/white?text=مدرس'">
            <div>
                <h3>${teacher.name}</h3>
                <p>${teacher.subject}</p>
            </div>
        </div>
    `;

    const completed = getFromStorage(STORAGE_KEYS.COMPLETED);

    classData.lectures.forEach((lecture, index) => {
        const lectureId = generateLectureId(teacher.id, className, lecture.title);
        const isCompleted = completed.includes(lectureId);

        const card = document.createElement('div');
        card.className = `lecture-card ${isCompleted ? 'completed' : ''}`;
        card.onclick = (e) => {
            if (!e.target.closest('.btn-check')) {
                currentLectures = classData.lectures;
                currentLectureIndex = index;
                playLecture(lecture, teacher);
            }
        };

        card.innerHTML = `
            <div class="lecture-header">
                <h3 class="lecture-title">${lecture.title}</h3>
                <button class="btn-check ${isCompleted ? 'completed' : ''}" onclick="event.stopPropagation(); toggleLectureCompletion('${lectureId}', this)">
                    <i class="fas fa-check"></i>
                </button>
            </div>
            <p class="lecture-description">${lecture.description}</p>
            <div class="lecture-footer">
                <span class="lecture-duration">
                    <i class="fas fa-play-circle"></i> مشاهدة المحاضرة
                </span>
            </div>
        `;

        container.appendChild(card);
    });

    updateBreadcrumb([
        { text: 'الرئيسية', onclick: () => showHome() },
        { text: `محاضرات ${currentYear}`, onclick: () => showSubjects(data) },
        { text: currentSubject.replace(/^مدرس مادة\s+/, ''), onclick: () => showTeachers(currentSubject, data) },
        { text: teacher.name, onclick: () => showClasses(teacher, data) },
        { text: className }
    ]);
}

// Generate unique lecture ID
function generateLectureId(teacherId, className, lectureTitle) {
    return `${teacherId}-${className}-${lectureTitle}`.replace(/\s+/g, '-');
}

// Generate unique key for video progress
function generateUniqueKey(url) {
    // Create a simple hash from the URL
    let hash = 0;
    for (let i = 0; i < url.length; i++) {
        const char = url.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return Math.abs(hash).toString();
}

// Update lecture status function
function updateLectureStatus(lectureKey, isCompleted) {
    if (isCompleted) {
        localStorage.setItem(lectureKey, 'completed');
        showToast('تم إكمال المحاضرة!', 'success');
    }
}

// Cleanup function - Enhanced with complete cleanup
function cleanupVideoPlayer() {
    console.log('Cleaning up video player...');

    // تنظيف HLS
    if (window.currentHls) {
        try {
            window.currentHls.destroy();
        } catch(e) {
            console.log('Error destroying HLS:', e);
        }
        window.currentHls = null;
    }

    // تنظيف الفترة الزمنية للحفظ
    if (window.currentSaveInterval) {
        clearInterval(window.currentSaveInterval);
        window.currentSaveInterval = null;
    }

    // تنظيف مشغل Plyr
    if (window.player) {
        try {
            if (window.player.pause) {
                window.player.pause();
            }
            if (window.player.destroy) {
                window.player.destroy();
            }
        } catch(e) {
            console.log('Error destroying Plyr player:', e);
        }
        window.player = null;
    }

    // تنظيف عنصر الفيديو
    const video = document.getElementById('player') || document.getElementById('video-player');
    if (video) {
        try {
            video.pause();
            video.removeAttribute('src');
            video.load();
            // إزالة جميع event listeners
            video.onloadedmetadata = null;
            video.onended = null;
            video.onerror = null;
        } catch(e) {
            console.log('Error cleaning video element:', e);
        }
    }

    // تنظيف iframe
    const iframe = document.getElementById('current-iframe');
    if (iframe) {
        try {
            iframe.src = 'about:blank';
            setTimeout(() => {
                if (iframe.parentNode) {
                    iframe.parentNode.removeChild(iframe);
                }
            }, 100);
        } catch(e) {
            console.log('Error cleaning iframe:', e);
        }
    }

    // تنظيف شامل للحاويات
    const containers = [
        document.querySelector('.video-player-container'),
        document.querySelector('.video-wrapper'),
        document.getElementById('video-player')?.parentElement
    ];

    containers.forEach(container => {
        if (container && container.innerHTML &&
            (container.innerHTML.includes('video') || container.innerHTML.includes('iframe'))) {
            try {
                // إيقاف جميع الوسائط في الحاوي
                const videos = container.querySelectorAll('video');
                videos.forEach(v => {
                    v.pause();
                    v.removeAttribute('src');
                    v.load();
                });

                const iframes = container.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    iframe.src = 'about:blank';
                });

            } catch(e) {
                console.log('Error cleaning container:', e);
            }
        }
    });

    console.log('Video player cleanup completed');
}

// Call cleanup when leaving the page
window.addEventListener('beforeunload', cleanupVideoPlayer);
window.addEventListener('pagehide', cleanupVideoPlayer);

// Add cleanup for browser back/forward buttons
window.addEventListener('popstate', () => {
    const video = document.getElementById('video-player');
    if (video) {
        video.pause();
        video.currentTime = 0;
    }
    cleanupVideoPlayer();
});

// Play Lecture - Simplified (No Custom Controls)
// إصلاح مشكلة عرض الفيديو - استبدل دالة playLecture بهذه
function playLecture(lecture, teacher) {
    hideAllPages();
    document.getElementById('player-page').classList.add('active');

    // البحث عن الحاوي الصحيح أو إنشاؤه
    let container = document.querySelector('.video-player-container') ||
                   document.querySelector('.video-wrapper') ||
                   document.getElementById('video-player')?.parentElement;

    // إذا لم يوجد الحاوي، ابحث في صفحة المشغل
    if (!container) {
        const playerPage = document.getElementById('player-page');
        container = playerPage.querySelector('.video-container') ||
                   playerPage.querySelector('[class*="video"]') ||
                   playerPage.querySelector('div');

        // إنشاء حاوي جديد إذا لم يوجد
        if (!container) {
            container = document.createElement('div');
            container.className = 'video-player-container';
            container.style.cssText = `
                width: 100%;
                max-width: 100%;
                position: relative;
                background: #000;
                min-height: 400px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            playerPage.appendChild(container);
        }
    }

    const FORCED_REFERER = 'https://abwaab.com';

    const isHLS = lecture.url.includes('.m3u8');
    const uniqueKey = generateUniqueKey(lecture.url);
    const storageKey = `${uniqueKey}-progress`;
    const durationKey = `${uniqueKey}-duration`;

    // تنظيف شامل لأي تشغيل سابق
    cleanupVideoPlayer();

    // تنظيف الحاوي بالكامل
    container.innerHTML = '';
    container.style.display = 'block';
    container.style.visibility = 'visible';

    // ✅ iframe handling
    if (lecture.url.includes("iframe.mediadelivery.net/embed/") || lecture.url.includes("iframe")) {
        const iframeUrl = `https://22proxxy.eduiraq.my/proxy?url=${encodeURIComponent(lecture.url)}&referer=${encodeURIComponent(FORCED_REFERER)}`;

        container.innerHTML = `
            <div style="position: relative; width: 100%; padding-top: 56.25%; background: #000; overflow: hidden; border-radius: 8px;">
                <iframe
                    id="current-iframe"
                    src="${iframeUrl}"
                    allowfullscreen
                    loading="eager"
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 8px; display: block;"
                    referrerpolicy="no-referrer-when-downgrade"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen">
                </iframe>
            </div>
        `;

        console.log('iframe created successfully');
    } else {
        // ✅ Regular video - إصلاح العرض
        container.innerHTML = `
            <div style="position: relative; width: 100%; max-width: 100%; background: #000; border-radius: 8px; overflow: hidden;">
                <video
                    id="player"
                    playsinline
                    controls
                    preload="metadata"
                    style="
                        width: 100% !important;
                        height: auto !important;
                        max-width: 100% !important;
                        display: block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        background: #000;
                        object-fit: contain;
                        min-height: 300px;
                    "
                    onloadstart="console.log('Video loading started')"
                    onloadeddata="console.log('Video data loaded')"
                    oncanplay="console.log('Video can play')"
                >
                    <p style="color: white; text-align: center; padding: 20px;">متصفحك لا يدعم عرض الفيديو.</p>
                </video>
            </div>
        `;

        const videoElement = document.getElementById('player');

        if (!videoElement) {
            showToast('خطأ في إنشاء مشغل الفيديو', 'error');
            return;
        }

        // إجبار ظهور الفيديو
        videoElement.style.display = 'block';
        videoElement.style.visibility = 'visible';
        videoElement.style.opacity = '1';

        // التأكد من أن Plyr متوفر قبل الاستخدام
        let usingPlyr = false;
        if (typeof Plyr !== 'undefined') {
            try {
                // إنشاء مشغل Plyr
                window.player = new Plyr('#player', {
                    seekTime: 10,
                    controls: [
                        'play-large', 'rewind', 'play', 'fast-forward', 'progress',
                        'current-time', 'mute', 'volume', 'settings', 'fullscreen'
                    ],
                    settings: ['speed'],
                    speed: { selected: 1, options: [1, 1.25, 1.5, 2] },
                    autoplay: false,
                    preload: 'metadata',
                    fullscreen: { enabled: true, fallback: true, iosNative: true },
                    ratio: '16:9' // إضافة نسبة العرض
                });

                usingPlyr = true;
                console.log('Plyr player created successfully');

                // إجبار إعادة تحميل Plyr
                setTimeout(() => {
                    if (window.player && window.player.media) {
                        window.player.media.style.display = 'block';
                        window.player.media.style.visibility = 'visible';
                    }
                }, 100);

            } catch(e) {
                console.log('Plyr creation failed, using native controls:', e);
                videoElement.controls = true;
            }
        } else {
            console.log('Plyr not available, using native controls');
            videoElement.controls = true;
        }

        function setupMetadata() {
            videoElement.onloadedmetadata = () => {
                console.log('Video metadata loaded');
                const duration = videoElement.duration;
                if (!isNaN(duration) && duration > 0) {
                    localStorage.setItem(durationKey, duration.toFixed(1));                }

                const savedTime = localStorage.getItem(storageKey);
                if (savedTime && savedTime !== 'completed') {
                    const time = parseFloat(savedTime);
                    if (!isNaN(time) && time > 0) {
                        videoElement.currentTime = time;
                    }
                }

                // إجبار إعادة رسم الفيديو
                videoElement.style.display = 'block';
                videoElement.style.visibility = 'visible';
            };

            videoElement.oncanplay = () => {
                console.log('Video can play - forcing display');
                videoElement.style.display = 'block';
                videoElement.style.visibility = 'visible';
                videoElement.style.opacity = '1';
            };

            videoElement.onplaying = () => {
                console.log('Video is playing');
                videoElement.style.display = 'block';
                videoElement.style.visibility = 'visible';
            };

            const saveInterval = setInterval(() => {
                if (!videoElement.paused && !videoElement.ended && videoElement.currentTime > 0) {
                    localStorage.setItem(storageKey, videoElement.currentTime.toFixed(1));
                }
            }, 2000);

            videoElement.onended = () => {
                clearInterval(saveInterval);
                localStorage.setItem(storageKey, 'completed');
                updateLectureStatus(storageKey, true);

                // Auto play next lecture
                setTimeout(() => {
                    if (currentLectureIndex < currentLectures.length - 1) {                        playNextLecture();
                    }
                }, 2000);
            };

            window.currentSaveInterval = saveInterval;
        }

        function playWithProxyHLS(cleanedUrl) {
            const proxiedUrl = `https://proxy.eduiraq.my/proxy?url=${encodeURIComponent(cleanedUrl)}&referer=${encodeURIComponent(FORCED_REFERER)}`;

            if (typeof Hls === 'undefined') {
                showToast('مكتبة HLS غير متوفرة', 'error');
                return;
            }

            const hls = new Hls({
                xhrSetup: function (xhr, originalUrl) {
                    const isAlreadyProxied = originalUrl.includes("proxy.eduiraq.my");
                    const finalUrl = isAlreadyProxied
                        ? originalUrl
                        : `https://proxy.eduiraq.my/proxy?url=${encodeURIComponent(originalUrl)}&referer=${encodeURIComponent(FORCED_REFERER)}`;

                    xhr.open('GET', finalUrl, true);
                    xhr.setRequestHeader('Referer', FORCED_REFERER);
                    xhr.setRequestHeader('Origin', 'https://abwaab.com');
                }
            });

            window.currentHls = hls;
            hls.loadSource(proxiedUrl);
            hls.attachMedia(videoElement);

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                console.log('HLS manifest parsed');
                setupMetadata();
                // محاولة التشغيل التلقائي
                videoElement.play().catch(e => {
                    console.log('HLS autoplay failed:', e);
                    showToast('اضغط على تشغيل لبدء المحاضرة', 'info');
                });
            });

            hls.on(Hls.Events.ERROR, (_, data) => {
                if (data.fatal) {
                    hls.destroy();
                    console.warn("❌ HLS Fatal Error:", data);
                    showToast('فشل في تحميل الفيديو', 'error');
                }
            });
        }

        function tryPlayHLS() {
            if (typeof Hls === 'undefined' || !Hls.isSupported()) {
                tryPlayMP4();
                return;
            }

            // تجربة بدون بروكسي أولاً
            const directHls = new Hls();
            window.currentHls = directHls;

            directHls.loadSource(lecture.url);
            directHls.attachMedia(videoElement);

            let errored = false;

            directHls.on(Hls.Events.MANIFEST_PARSED, () => {
                console.log('Direct HLS manifest parsed');
                setupMetadata();
                videoElement.play().catch(() => {
                    if (!errored) {
                        errored = true;
                        directHls.destroy();
                        tryProxy();
                    }
                });
            });

            directHls.on(Hls.Events.ERROR, (_, data) => {
                if (data.fatal && !errored) {
                    errored = true;
                    directHls.destroy();
                    tryProxy();
                }
            });

            function tryProxy() {
                // تنظيف الرابط إذا كان فيه بروكسي مكرر
                let cleanUrl = lecture.url;
                try {
                    const parsed = new URL(lecture.url);
                    if (parsed.hostname.includes("proxy.eduiraq.my") && parsed.searchParams.has("url")) {
                        cleanUrl = decodeURIComponent(parsed.searchParams.get("url"));
                    }
                } catch (e) {
                    console.warn("❌ Failed to clean nested proxy URL:", e.message);
                }

                playWithProxyHLS(cleanUrl);
            }
        }

        function tryPlayMP4() {
            console.log('Attempting MP4 playback');

            // تجربة تشغيل مباشر أولاً
            videoElement.src = lecture.url;

            const handleError = () => {
                console.log('Direct MP4 failed, trying proxy');
                // فشل، جرب البروكسي
                const proxiedUrl = `https://proxy.eduiraq.my/proxy?url=${encodeURIComponent(lecture.url)}&referer=${encodeURIComponent(FORCED_REFERER)}`;
                videoElement.src = proxiedUrl;

                videoElement.onerror = () => {
                    console.error("❌ Failed to load MP4 with proxy");
                    showToast('فشل في تحميل الفيديو', 'error');
                };

                setupMetadata();
            };

            videoElement.onerror = handleError;

            setupMetadata();

            // محاولة التشغيل مع معالجة الأخطاء
            videoElement.play().catch((error) => {
                console.log('MP4 play failed:', error);
                handleError();
            });
        }

        // تحديد نوع الفيديو وتشغيله
        setTimeout(() => {
            if (isHLS) {
                tryPlayHLS();
            } else {
                tryPlayMP4();
            }
        }, 100);
    }

    // باقي الكود يبقى كما هو...
    const lectureTitle = document.getElementById('lecture-title');
    const teacherName = document.getElementById('teacher-name');
    const teacherSubject = document.getElementById('teacher-subject');

    if (lectureTitle) lectureTitle.textContent = lecture.title;
    if (teacherName) teacherName.textContent = teacher.name;
    if (teacherSubject) teacherSubject.textContent = teacher.subject;

    // Set teacher avatar with proper error handling
    const teacherAvatar = document.getElementById('teacher-avatar');
    if (teacherAvatar) {
        teacherAvatar.src = '';
        teacherAvatar.onerror = function() {
            this.src = 'https://via.placeholder.com/60x60/667eea/white?text=مدرس';
            this.onerror = null;
        };

        if (teacher.image && teacher.image.trim() !== '') {
            teacherAvatar.src = teacher.image;
        } else {
            teacherAvatar.src = 'https://via.placeholder.com/60x60/667eea/white?text=مدرس';
        }

        teacherAvatar.style.display = 'block';
        teacherAvatar.style.visibility = 'visible';
    }

    // Update lecture description
    const lectureDescElement = document.querySelector('.lecture-description p');
    if (lectureDescElement) {
        const fullDescription = `
            ${lecture.description}<br><br>
            <div style="display:inline-flex;align-items:center;gap:0.3rem;font-size:1rem;line-height:1.4;">
                <span>📱 تابعنا على إنستغرام:</span>
                <a href="https://www.instagram.com/l1pll_" target="_blank" rel="noopener noreferrer" style="display:inline-flex;align-items:center;text-decoration:none;color:#e1306c;font-weight:600;">
                    <i class="fab fa-instagram" style="margin-left:0.3rem;"></i>@l1pll_
                </a>
            </div><br>
            <div style="margin-top:0.75rem;display:inline-flex;align-items:center;gap:0.3rem;font-size:1rem;font-weight:bold;line-height:1.4;">
                <span>📺 قناة المطور للمحاضرات المسربة:</span>
                <a href="https://t.me/allawi10_l" target="_blank" rel="noopener noreferrer" style="display:inline-flex;align-items:center;text-decoration:none;color:#0088cc;">
                    <i class="fab fa-telegram" style="margin-left:0.3rem;"></i>@allawi10_l
                </a>
            </div>
        `;
        lectureDescElement.innerHTML = fullDescription;
    }

    // Update buttons state
    if (typeof updatePlayerButtons === 'function') {
        updatePlayerButtons(lecture, teacher);
    }
    if (typeof updateNavigationButtons === 'function') {
        updateNavigationButtons();
    }

    // Add to navigation history
    navigationHistory.push({
        type: 'lectures',
        teacher: teacher,
        className: currentClass,
        data: currentData
    });

    console.log('playLecture completed successfully');
}

function updatePlayerButtons(lecture, teacher) {
    const lectureId = generateLectureId(teacher.id, currentClass, lecture.title);
    const completed = getFromStorage(STORAGE_KEYS.COMPLETED);
    const favorites = getFromStorage(STORAGE_KEYS.FAVORITES);

    const btnComplete = document.getElementById('btn-complete');
    const btnFavorite = document.getElementById('btn-favorite');

    if (completed.includes(lectureId)) {
        btnComplete.classList.add('completed');
        btnComplete.innerHTML = '<i class="fas fa-check"></i> تم الانتهاء';    } else {
        btnComplete.classList.remove('completed');
        btnComplete.innerHTML = '<i class="fas fa-check"></i> تم الانتهاء';    }

    if (favorites.includes(teacher.id)) {
        btnFavorite.classList.add('active');
        btnFavorite.innerHTML = '<i class="fas fa-star"></i> في المفضلة';
    } else {
        btnFavorite.classList.remove('active');
        btnFavorite.innerHTML = '<i class="fas fa-star"></i> إضافة للمفضلة';
    }

    // Store current lecture and teacher for button functions
    btnComplete.onclick = () => toggleCurrentLectureCompletion(lectureId);
    btnFavorite.onclick = () => toggleCurrentTeacherFavorite(teacher.id);
}

function updateNavigationButtons() {
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');

    btnPrev.disabled = currentLectureIndex === 0;
    btnNext.disabled = currentLectureIndex === currentLectures.length - 1;
}

// Favorites Functions
function toggleFavorite(teacherId) {
    const favorites = getFromStorage(STORAGE_KEYS.FAVORITES);
    const index = favorites.indexOf(teacherId);

    if (index > -1) {
        favorites.splice(index, 1);
        showToast('تم إزالة المدرس من المفضلة', 'success');
    } else {
        favorites.push(teacherId);
        showToast('تم إضافة المدرس للمفضلة', 'success');
    }

    saveToStorage(STORAGE_KEYS.FAVORITES, favorites);

    // Update UI
    const starBtn = event.target.closest('.btn-star');
    starBtn.classList.toggle('active');
}

function toggleCurrentTeacherFavorite(teacherId) {
    toggleFavorite(teacherId);
    updatePlayerButtons(currentLectures[currentLectureIndex], currentTeacher);
}

function showFavorites() {
    hideAllPages();
    document.getElementById('favorites-page').classList.add('active');

    const favorites = getFromStorage(STORAGE_KEYS.FAVORITES);
    const container = document.getElementById('favorites-container');
    container.innerHTML = '';

    if (favorites.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-star" style="font-size: 4rem; color: rgba(255, 255, 255, 0.3); margin-bottom: 1rem;"></i>
                <h3 style="color: #fff; margin-bottom: 1rem;">لا توجد مدرسين في المفضلة</h3>
                <p style="color: rgba(255, 255, 255, 0.8);">أضف مدرسينك المفضلين لسهولة الوصول إليهم</p>
            </div>
        `;
        return;
    }

    // Get all teachers from both years with error checking
    const allTeachers = [];

    if (typeof teacherData2025 !== 'undefined' && teacherData2025.teachers) {
        allTeachers.push(...teacherData2025.teachers);
    }

    if (typeof teacherData2026 !== 'undefined' && teacherData2026.teachers) {
        allTeachers.push(...teacherData2026.teachers);
    }

    if (allTeachers.length === 0) {
        showToast('خطأ في تحميل بيانات المدرسين', 'error');
        showHome();
        return;
    }

    const favoriteTeachers = allTeachers.filter(teacher => favorites.includes(teacher.id));
    const completed = getFromStorage(STORAGE_KEYS.COMPLETED);

    favoriteTeachers.forEach(teacher => {
        const totalLectures = teacher.classes.reduce((total, cls) => total + cls.lectures.length, 0);
        const completedLectures = getCompletedLecturesForTeacher(teacher, completed);

        const card = document.createElement('div');
        card.className = 'teacher-card';
        card.onclick = (e) => {
            if (!e.target.closest('.teacher-actions')) {
                try {
                    // Determine which year this teacher belongs to
                    let yearData = null;
                    let year = '';

                    if (typeof teacherData2025 !== 'undefined' && teacherData2025.teachers &&
                        teacherData2025.teachers.some(t => t.id === teacher.id)) {
                        yearData = teacherData2025;
                        year = '2025';
                    } else if (typeof teacherData2026 !== 'undefined' && teacherData2026.teachers &&
                               teacherData2026.teachers.some(t => t.id === teacher.id)) {
                        yearData = teacherData2026;
                        year = '2026';
                    }

                    if (!yearData) {
                        throw new Error('Could not find teacher data');
                    }

                    currentYear = year;
                    currentData = yearData;
                    currentSubject = teacher.subject;

                    navigationHistory.push({ type: 'favorites' });
                    showClasses(teacher, yearData);
                } catch (error) {
                    console.error('Error navigating from favorites:', error);
                    showToast('خطأ في الانتقال إلى المدرس', 'error');
                }
            }
        };

        card.innerHTML = `
            <img src="${teacher.image}" alt="${teacher.name}" class="teacher-avatar" onerror="this.src='https://via.placeholder.com/80x80/667eea/white?text=مدرس'">
            <h3 class="teacher-name">${teacher.name}</h3>
            <p class="teacher-subject">${teacher.subject}</p>
            <div class="teacher-stats">
                <div class="stat">
                    <span class="stat-number">${totalLectures}</span>
                    <span class="stat-label">محاضرة</span>
                </div>
                <div class="stat">
                    <span class="stat-number">${completedLectures}</span>
                    <span class="stat-label">مكتملة</span>
                </div>
            </div>
            <div class="teacher-actions">
                <button class="btn-star active" onclick="toggleFavorite(${teacher.id})">
                    <i class="fas fa-star"></i>
                </button>
            </div>
        `;

        container.appendChild(card);
    });

    updateBreadcrumb([
        { text: 'الرئيسية', onclick: () => showHome() },
        { text: 'المدرسين المفضلين' }
    ]);
}

// Lecture Completion Functions
function toggleLectureCompletion(lectureId, button) {
    const completed = getFromStorage(STORAGE_KEYS.COMPLETED);
    const index = completed.indexOf(lectureId);

    if (index > -1) {
        completed.splice(index, 1);
        button.classList.remove('completed');
        button.closest('.lecture-card').classList.remove('completed');
        showToast('تم إزالة علامة الانتهاء', 'success');
    } else {
        completed.push(lectureId);
        button.classList.add('completed');
        button.closest('.lecture-card').classList.add('completed');
        showToast('تم وضع علامة الانتهاء', 'success');
    }

    saveToStorage(STORAGE_KEYS.COMPLETED, completed);
}

function toggleCurrentLectureCompletion(lectureId) {
    const completed = getFromStorage(STORAGE_KEYS.COMPLETED);
    const index = completed.indexOf(lectureId);

    if (index > -1) {
        completed.splice(index, 1);
        showToast('تم إزالة علامة الانتهاء', 'success');
    } else {
        completed.push(lectureId);
        showToast('تم وضع علامة الانتهاء', 'success');
    }

    saveToStorage(STORAGE_KEYS.COMPLETED, completed);
    updatePlayerButtons(currentLectures[currentLectureIndex], currentTeacher);
}

// Navigation in Player
function playPreviousLecture() {
    if (currentLectureIndex > 0) {
        currentLectureIndex--;
        const lecture = currentLectures[currentLectureIndex];
        playLecture(lecture, currentTeacher);
        showToast('المحاضرة السابقة', 'success');
    }
}

function playNextLecture() {
    if (currentLectureIndex < currentLectures.length - 1) {
        currentLectureIndex++;
        const lecture = currentLectures[currentLectureIndex];
        playLecture(lecture, currentTeacher);
        showToast('المحاضرة التالية', 'success');
    }
}

// Utility Functions
function showLoading() {
    document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Enhanced Keyboard Navigation - Bunny.net Style
document.addEventListener('keydown', function(e) {
    if (!document.getElementById('player-page').classList.contains('active')) return;

    const video = document.getElementById('video-player');
    if (!video) return;

    // Prevent default for video-related keys
    const videoKeys = [' ', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'm', 'M', 'f', 'F', 'p', 'P', 'k', 'K', 'j', 'J', 'l', 'L', 'c', 'C'];
    if (videoKeys.includes(e.key)) {
        e.preventDefault();
    }

    switch(e.key) {
        case ' ':
        case 'k':
        case 'K':
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
            break;
        case 'ArrowLeft':
        case 'j':
        case 'J':
            if (e.ctrlKey) {
                playPreviousLecture();
            } else {
                video.currentTime = Math.max(0, video.currentTime - 10);
                document.getElementById('video-toast').textContent = 'تراجع 10 ثواني';
                document.getElementById('video-toast').classList.add('show');
                setTimeout(() => document.getElementById('video-toast').classList.remove('show'), 1500);
            }
            break;
        case 'ArrowRight':
        case 'l':
        case 'L':
            if (e.ctrlKey) {
                playNextLecture();
            } else {
                video.currentTime = Math.min(video.duration, video.currentTime + 10);
                document.getElementById('video-toast').textContent = 'تقديم 10 ثواني';
                document.getElementById('video-toast').classList.add('show');
                setTimeout(() => document.getElementById('video-toast').classList.remove('show'), 1500);
            }
            break;
        case 'ArrowUp':
            video.volume = Math.min(1, video.volume + 0.1);
            video.muted = false;
            document.getElementById('video-toast').textContent = `مستوى الصوت: ${Math.round(video.volume * 100)}%`;
            document.getElementById('video-toast').classList.add('show');
            setTimeout(() => document.getElementById('video-toast').classList.remove('show'), 1500);
            break;
        case 'ArrowDown':
            video.volume = Math.max(0, video.volume - 0.1);
            document.getElementById('video-toast').textContent = `مستوى الصوت: ${Math.round(video.volume * 100)}%`;
            document.getElementById('video-toast').classList.add('show');
            setTimeout(() => document.getElementById('video-toast').classList.remove('show'), 1500);
            break;
        case 'm':
        case 'M':
            video.muted = !video.muted;
            document.getElementById('video-toast').textContent = video.muted ? 'تم كتم الصوت' : 'تم إلغاء الكتم';
            document.getElementById('video-toast').classList.add('show');
            setTimeout(() => document.getElementById('video-toast').classList.remove('show'), 1500);
            break;
        case 'f':
        case 'F':
            if (!document.fullscreenElement) {
                document.querySelector('.video-wrapper').requestFullscreen().catch(console.error);
            } else {
                document.exitFullscreen();
            }
            break;
        case 'p':
        case 'P':
            // Picture-in-Picture
            if (!document.pictureInPictureElement) {
                if (video.requestPictureInPicture) {
                    video.requestPictureInPicture().catch(console.error);
                }
            } else {
                document.exitPictureInPicture();
            }
            break;
        case 'c':
        case 'C':
            // Toggle captions (placeholder for future implementation)
            document.getElementById('video-toast').textContent = 'الترجمة غير متاحة';
            document.getElementById('video-toast').classList.add('show');
            setTimeout(() => document.getElementById('video-toast').classList.remove('show'), 1500);
            break;
        case '1':
            video.playbackRate = 1;
            document.getElementById('speed-btn').querySelector('span').textContent = '1x';
            document.getElementById('video-toast').textContent = 'سرعة عادية';
            document.getElementById('video-toast').classList.add('show');
            setTimeout(() => document.getElementById('video-toast').classList.remove('show'), 1500);
            break;
        case '2':
            video.playbackRate = 2;
            document.getElementById('speed-btn').querySelector('span').textContent = '2x';
            document.getElementById('video-toast').textContent = 'سرعة مضاعفة';
            document.getElementById('video-toast').classList.add('show');
            setTimeout(() => document.getElementById('video-toast').classList.remove('show'), 1500);
            break;
        case 'Escape':
            goBack();
            break;
    }
});

// Search functionality (bonus feature)
function searchLectures(query) {
    const results = [];
    const allData = [teacherData2025, teacherData2026];

    allData.forEach((data, yearIndex) => {
        const year = yearIndex === 0 ? '2025' : '2026';
        data.teachers.forEach(teacher => {
            teacher.classes.forEach(cls => {
                cls.lectures.forEach(lecture => {
                    if (lecture.title.includes(query) ||
                        teacher.name.includes(query) ||
                        teacher.subject.includes(query) ||
                        cls.name.includes(query)) {
                        results.push({
                            lecture,
                            teacher,
                            className: cls.name,
                            year
                        });
                    }
                });
            });
        });
    });

    return results;
}

// Performance optimization - Lazy loading images
function lazyLoadImages() {
    const images = document.querySelectorAll('img[data-src]');

    const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove('lazy');
                imageObserver.unobserve(img);
            }
        });
    });

    images.forEach(img => imageObserver.observe(img));
}

// Initialize lazy loading when DOM is ready
document.addEventListener('DOMContentLoaded', lazyLoadImages);

// Service Worker for offline functionality (optional)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
                console.log('ServiceWorker registration successful');
            })
            .catch(function(err) {
                console.log('ServiceWorker registration failed');
            });
    });
}

(function () {
          let detected = false;

          function triggerSecurity() {
                if (detected) return;
                detected = true;

                document.documentElement.innerHTML = '';
                alert("🚨 تم اكتشاف محاولة فحص، وتم تسجيل عنوان IP الخاص بك.");

                fetch('/api/log-inspect', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                        time: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        username: localStorage.getItem('username') || 'غير معروف'
                  })
                });

                setTimeout(() => location.href = "/", 1000);
          }

          // كشف فتح DevTools عبر console.log + Object.defineProperty
          const el = new Image();
          Object.defineProperty(el, 'id', {
                get: function () {
                  triggerSecurity();
                }
          });
          console.log('%c🚫 لا تحاول العبث بالكود!', 'font-size:100px;', el);

          // كشف DevTools بـ new Function بدل debugger فقط
          function detectDebuggerDelay() {
                const start = performance.now();
                new Function("debugger")(); // bypass Disable Breakpoints
                const duration = performance.now() - start;
                if (duration > 100) {
                  triggerSecurity();
                }
          }

          function detectWindowResize() {
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent) ||
                (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  if (isIOS) return;

  const widthDiff = window.outerWidth - window.innerWidth;
  const heightDiff = window.outerHeight - window.innerHeight;

  const maxAllowedDiff = 1000;
  const minSuspiciousDiff = 160;

  if ((widthDiff > minSuspiciousDiff && widthDiff < maxAllowedDiff) ||
      (heightDiff > minSuspiciousDiff && heightDiff < maxAllowedDiff)) {
    triggerSecurity();
  }
}

          // تكرار الفحص كل ثانية
          setInterval(() => {
                detectDebuggerDelay();
                detectWindowResize();
          }, 1000);

          // منع جميع الاختصارات الحساسة
          document.addEventListener("keydown", function (e) {
                const combo = `${e.ctrlKey ? "CTRL+" : ""}${e.shiftKey ? "SHIFT+" : ""}${e.key.toUpperCase()}`;
                const forbidden = [
                  "F12",
                  "CTRL+SHIFT+I",
                  "CTRL+SHIFT+C",
                  "CTRL+SHIFT+J",
                  "CTRL+U",
                  "CTRL+S",
                  "CTRL+A",
                  "CTRL+C",
                  "CTRL+P",
                  "CTRL+E",
                  "CTRL+SHIFT+E",
                  "CTRL+SHIFT+K"
                ];
                if (forbidden.includes(combo)) {
                  e.preventDefault();
                  triggerSecurity();
                }
          });

          // منع الزر الأيمن
          document.addEventListener("contextmenu", function (e) {
                e.preventDefault();
          });

          // منع السحب والتحديد
          document.addEventListener("selectstart", e => e.preventDefault());
          document.addEventListener("dragstart", e => e.preventDefault());

        })();

    
    </script>

</body>
</html>
